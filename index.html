<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced 3D Earth - Hand Controller</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        body { margin: 0; background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* UI Elements */
        #gui {
            position: absolute;
            top: 20px; left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #444;
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .stat-item { margin-bottom: 10px; font-size: 14px; }
        .label { color: #888; margin-right: 10px; }
        .value { color: #00d2ff; font-weight: bold; }

        /* Video Feed */
        #video-panel {
            position: absolute;
            bottom: 20px; right: 20px;
            width: 280px; height: 210px;
            border-radius: 12px;
            border: 2px solid #00d2ff;
            background: #111;
            overflow: hidden;
            transform: scaleX(-1);
        }
        #input_video { width: 100%; height: 100%; object-fit: cover; }
        #output_canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* Loading Screen */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .loader {
            width: 60px; height: 60px;
            border: 5px solid #111; border-top: 5px solid #00d2ff;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loader"></div>
        <p style="margin-top: 20px;">กำลังดาวน์โหลดแผนที่โลกและเปิดระบบ AI...</p>
    </div>

    <div id="gui">
        <h2 style="margin:0 0 15px 0; color: #00d2ff;">Earth Controller 2.0</h2>
        <div class="stat-item"><span class="label">สถานะมือ:</span> <span id="hand-status" class="value">ไม่พบมือ</span></div>
        <div class="stat-item"><span class="label">การควบคุม:</span> <span id="gesture-action" class="value">Idle</span></div>
        <div class="stat-item"><span class="label">ระดับการซูม:</span> <span id="zoom-level" class="value">1.0x</span></div>
        <hr style="border: 0; border-top: 1px solid #333; margin: 15px 0;">
        <div style="font-size: 12px; color: #aaa;">
            • ขยับนิ้วชี้เพื่อหมุนโลก<br>
            • จีบนิ้วโป้ง+ชี้ เพื่อซูมเข้า/ออก
        </div>
    </div>

    <div id="video-panel">
        <video id="input_video"></video>
        <canvas id="output_canvas"></canvas>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const loadingScreen = document.getElementById('loading-screen');
        
        // UI Refs
        const handStatusUI = document.getElementById('hand-status');
        const gestureUI = document.getElementById('gesture-action');
        const zoomUI = document.getElementById('zoom-level');

        let scene, camera, renderer, earth, clouds;
        let targetRotationX = 0, targetRotationY = 0;
        let targetZoom = 15;

        // --- 1. Three.js: Realistic Earth Setup ---
        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);
            const sunLight = new THREE.DirectionalLight(0xffffff, 1.2);
            sunLight.position.set(5, 3, 5);
            scene.add(sunLight);

            // Texture Loader
            const loader = new THREE.TextureLoader();
            
            // Earth
            const earthGeo = new THREE.SphereGeometry(5, 64, 64);
            const earthMat = new THREE.MeshPhongMaterial({
                map: loader.load('https://unpkg.com/threejs-earth@1.0.1/src/img/earth_map.jpg'),
                bumpMap: loader.load('https://unpkg.com/threejs-earth@1.0.1/src/img/earth_bump.jpg'),
                bumpScale: 0.05,
                specularMap: loader.load('https://unpkg.com/threejs-earth@1.0.1/src/img/earth_specular.jpg'),
                specular: new THREE.Color('grey')
            });
            earth = new THREE.Mesh(earthGeo, earthMat);
            scene.add(earth);

            // Clouds
            const cloudGeo = new THREE.SphereGeometry(5.1, 64, 64);
            const cloudMat = new THREE.MeshPhongMaterial({
                map: loader.load('https://unpkg.com/threejs-earth@1.0.1/src/img/earth_clouds.png'),
                transparent: true,
                opacity: 0.4
            });
            clouds = new THREE.Mesh(cloudGeo, cloudMat);
            earth.add(clouds);

            camera.position.z = 15;
            animate();
        }

        // --- 2. Hand Tracking Logic ---
        function onResults(results) {
            loadingScreen.style.display = 'none';
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                handStatusUI.innerText = "กำลังควบคุม";
                handStatusUI.style.color = "#00ff88";
                
                const landmarks = results.multiHandLandmarks[0];
                
                // Draw hand skeleton
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
                drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1, radius: 2});

                // Control Logic
                const indexTip = landmarks[8];
                const thumbTip = landmarks[4];

                // A. Rotation Logic (using index finger)
                targetRotationY = (indexTip.x - 0.5) * Math.PI * 4;
                targetRotationX = (indexTip.y - 0.5) * Math.PI * 2;

                // B. Zoom Logic (Pinch Distance)
                const dx = indexTip.x - thumbTip.x;
                const dy = indexTip.y - thumbTip.y;
                const distance = Math.sqrt(dx*dx + dy*dy);

                if (distance < 0.05) { // จีบนิ้ว
                    targetZoom -= 0.2;
                    gestureUI.innerText = "ซูมเข้า (Pinch)";
                } else if (distance > 0.15) { // กางมือ
                    targetZoom += 0.2;
                    gestureUI.innerText = "ซูมออก (Spread)";
                } else {
                    gestureUI.innerText = "หมุนลูกโลก";
                }

                // Clamp Zoom
                targetZoom = Math.max(8, Math.min(25, targetZoom));
                zoomUI.innerText = ((25 - targetZoom) / 10 + 1).toFixed(1) + "x";

            } else {
                handStatusUI.innerText = "ไม่พบมือ";
                handStatusUI.style.color = "#ff4444";
                gestureUI.innerText = "อัตโนมัติ";
                earth.rotation.y += 0.002; // Auto spin
            }
        }

        // --- 3. Finalize & Loops ---
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6
        });
        hands.onResults(onResults);

        const cameraPipe = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });
        cameraPipe.start();

        function animate() {
            requestAnimationFrame(animate);
            
            if (earth) {
                // Smooth movement
                earth.rotation.y += (targetRotationY - earth.rotation.y) * 0.05;
                earth.rotation.x += (targetRotationX - earth.rotation.x) * 0.05;
                camera.position.z += (targetZoom - camera.position.z) * 0.1;
                
                // Cloud rotation
                if (clouds) clouds.rotation.y += 0.0005;
            }
            
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        initThree();
    </script>
</body>
</html>

